<!doctype html>
<html lang="vi">
  <head>
    <%- include('../partials/head') %>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
      <div class="container-fluid">
        <a class="navbar-brand" href="/listing">VPF</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCrawler" aria-controls="navbarCrawler" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCrawler">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link" href="/listing">Danh sách</a></li>
            <li class="nav-item"><a class="nav-link active" href="/crawler">Crawler</a></li>
          </ul>
        </div>
      </div>
    </nav>
    <main class="container py-3">
      <header class="mb-3">
        <h1 class="h5 mb-0">Crawler theo Template</h1>
        <div class="text-muted small">Chọn template và URL để cào, xem output và lưu JSON vào local</div>
      </header>

      <div class="row g-3">
        <div class="col-lg-4">
          <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>Templates</span>
              <div class="d-flex gap-2">
                <a class="btn btn-sm btn-outline-primary" href="/crawler/templates/new">New Template</a>
                <button class="btn btn-sm btn-outline-secondary" id="btn-load-templates">Refresh</button>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead class="table-light">
                    <tr><th>ID</th><th>Tên</th><th>Actions</th></tr>
                  </thead>
                  <tbody id="tpl-list">
                    <% (templates || []).forEach(function(t){ %>
                      <tr data-id="<%= t.id %>">
                        <td><%= t.id %></td>
                        <td><a href="/crawler/templates/<%= t.id %>"><%= t.name %></a></td>
                        <td><a class="btn btn-sm btn-outline-secondary" href="/crawler/templates/<%= t.id %>">Edit</a></td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <!-- Runner không dùng Task -->
        </div>
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header">Runner</div>
            <div class="card-body">
              <div class="row g-2">
                <div class="col-md-8">
                  <label class="form-label">URL</label>
                  <input id="d-url" class="form-control form-control-sm" />
                  <div class="form-text">Gợi ý: với VPF dùng đường dẫn có <code>pagejs=1#</code> và bật dynamic</div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Retain</label>
                  <input id="d-retain" type="number" class="form-control form-control-sm" value="5" />
                </div>
              </div>
              <hr />
              <div class="mb-2">
                <label class="form-label me-3">Cấu hình JSON</label>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="cfgMode" id="mode-template" value="template" checked />
                  <label class="form-check-label" for="mode-template">Dùng template</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="cfgMode" id="mode-custom" value="custom" />
                  <label class="form-check-label" for="mode-custom">Custom JSON</label>
                </div>
              </div>
              <div class="mb-2" id="tpl-select-wrap">
                <label class="form-label">Template</label>
                <select id="d-templateId" class="form-select form-select-sm"></select>
              </div>
              <div class="mb-2 d-none" id="tpl-json-wrap">
                <label class="form-label">Template JSON</label>
                <textarea id="d-template" class="form-control" rows="10"></textarea>
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" id="btn-run">Run</button>
              </div>
              <div class="mt-3">
                <div class="small text-muted mb-1">Tiến trình</div>
                <div class="progress" style="height: 18px;">
                  <div id="run-progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                </div>
                <div class="small mt-1" id="run-stage"></div>
              </div>
              <div class="mt-2">
                <div class="small text-muted">Output</div>
                <pre id="detail-output" class="bg-light p-2" style="max-height:280px;overflow:auto"></pre>
              </div>
              <hr />
              <div class="mt-2">
                <div class="small text-muted">Kết quả gần đây</div>
                <div class="table-responsive">
                  <table class="table table-sm align-middle">
                    <thead class="table-light">
                      <tr><th>File</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="results-tbody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      async function postJSON(url, body) {
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        if (!res.ok) { throw new Error(await res.text()); }
        return await res.json();
      }
      async function getJSON(url) {
        const res = await fetch(url);
        if (!res.ok) { throw new Error(await res.text()); }
        return await res.json();
      }
      async function refreshTemplates(){
        try {
          const data = await getJSON('/api/templates');
          const opts = ['<option value=\"\">-- Chọn template --</option>'].concat(
            (data.items || []).map(function(t){ return '<option value=\"'+t.id+'\">'+t.name+'</option>'; })
          ).join('');
          document.getElementById('d-templateId').innerHTML = opts;
          document.getElementById('tpl-list').innerHTML = (data.items || []).map(function(t){
            return '<tr data-id=\"'+t.id+'\">'
              + '<td>'+t.id+'</td>'
              + '<td><a href=\"/crawler/templates/'+t.id+'\">'+t.name+'</a></td>'
              + '<td><a class=\"btn btn-sm btn-outline-secondary\" href=\"/crawler/templates/'+t.id+'\">Edit</a></td>'
              + '</tr>';
          }).join('');
        } catch (e) {
          console.error(e);
        }
      }
      document.getElementById('btn-load-templates').addEventListener('click', refreshTemplates);
      refreshTemplates();
      // Runner actions
      document.getElementById('mode-template').addEventListener('change', function(){
        document.getElementById('tpl-select-wrap').classList.remove('d-none');
        document.getElementById('tpl-json-wrap').classList.add('d-none');
      });
      document.getElementById('mode-custom').addEventListener('change', function(){
        document.getElementById('tpl-select-wrap').classList.add('d-none');
        document.getElementById('tpl-json-wrap').classList.remove('d-none');
      });
      document.getElementById('btn-run').addEventListener('click', async function(){
        const url = document.getElementById('d-url').value;
        const retainLimit = parseInt(document.getElementById('d-retain').value || '5', 10);
        const mode = document.getElementById('mode-template').checked ? 'template' : 'custom';
        try {
          let payload = { url, retainLimit };
          let key = '';
          if (mode === 'template') {
            const templateId = document.getElementById('d-templateId').value || '';
            if (!templateId) { document.getElementById('detail-output').textContent = 'Chưa chọn template'; return; }
            payload.templateId = templateId;
            key = 'tpl-' + templateId;
          } else {
            const templateText = document.getElementById('d-template').value || '{}';
            const tpl = JSON.parse(templateText);
            payload.template = tpl;
            key = 'custom-' + Array.from(new TextEncoder().encode(templateText)).map(b=>b.toString(16).padStart(2,'0')).join('').slice(0,8);
          }
          const start = await postJSON('/api/run/start', payload);
          const jobId = start.jobId;
          let done = false;
          document.getElementById('run-stage').textContent = 'Khởi tạo...';
          const bar = document.getElementById('run-progress');
          bar.style.width = '0%'; bar.textContent = '0%';
          bar.classList.add('progress-bar-animated');
          while (!done) {
            await new Promise(r => setTimeout(r, 600));
            const s = await getJSON('/api/run/status/' + jobId);
            const pct = Math.max(0, Math.min(100, s.progress || 0));
            bar.style.width = pct + '%';
            bar.textContent = pct + '%';
            document.getElementById('run-stage').textContent = s.stage || '';
            if (s.done) {
              done = true;
              bar.classList.remove('progress-bar-animated');
              document.getElementById('detail-output').textContent = JSON.stringify(s, null, 2);
              await loadRunResults(key);
            }
          }
        } catch (e) {
          document.getElementById('detail-output').textContent = String(e.message || e);
        }
      });
      async function loadRunResults(key){
        try {
          const data = await getJSON('/api/run/results/'+encodeURIComponent(key)+'?limit=10');
          const tbody = document.getElementById('results-tbody');
          tbody.innerHTML = (data.items || []).map(function(r){
            return '<tr>'
              + '<td>'+r.name+'</td>'
              + '<td><button class=\"btn btn-sm btn-outline-secondary btn-view-result\" data-key=\"'+key+'\" data-name=\"'+r.name+'\">View</button></td>'
              + '</tr>';
          }).join('');
        } catch (e) { console.error(e); }
      }
      document.getElementById('results-tbody').addEventListener('click', async function(e){
        if (e.target.classList.contains('btn-view-result')) {
          const key = e.target.getAttribute('data-key');
          const name = e.target.getAttribute('data-name');
          if (!key || !name) return;
          const data = await getJSON('/api/run/results/'+encodeURIComponent(key)+'/'+encodeURIComponent(name));
          document.getElementById('detail-output').textContent = JSON.stringify(data, null, 2);
        }
      });
    </script>
  </body>
</html>
